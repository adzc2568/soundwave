<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>SOUNDWAVE | Profile</title>
  <link rel="Shortcut Icon" type="image/x-icon" href="./img/collection/smalllogo.ico" />
  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>

</head>

<body>
  <div id="nav_app">
    <!-- nav_bar start -->
    <div class="nav_bar flexbox">
      <div class="hamburger" @click="hamburger_click">
        <div class="hamburger-box">
          <div class="hamburger-inner"></div>
        </div>
      </div>
      <div class="mobile_list" @click="stopPropagation">
        <div class="paint_border"></div>
        <ul>
          <li class="REMIX flexbox">
            <a href="./remix.html">
            </a>
          </li>
          <li class="COLLECTION flexbox">
            <a href="./collection.html">
            </a>
          </li>
          <li class="ACTIVITY flexbox">
            <a href="./activity.html">
            </a>
          </li>
          <li class="LIBRARY flexbox">
            <a href="./library.html">
            </a>
          </li>
        </ul>
      </div>
      <div class="logo_container">
        <a href="./home.html">
          <div class="logo"></div>
        </a>
        <div class="finger"></div>
      </div>
      <ul class="main_list flexbox">
        <li class="REMIX flexbox">
          <a href="./remix.html">
          </a>
        </li>
        <li class="COLLECTION flexbox">
          <a href="./collection.html">
          </a>
        </li>
        <li class="ACTIVITY flexbox">
          <a href="./activity.html">
          </a>
        </li>
        <li class="LIBRARY flexbox">
          <a href="./library.html">
          </a>
        </li>
      </ul>
      <div class="search_bt" @click="search_bt_click">
        <a href="#"></a>
      </div>
      <div class="search_bar" @click="stopPropagation" v-bind:style="search_bar_style()">
        <input class="search" type="text" placeholder="Enter Song Name or Author" />
        <i class="fas fa-search" @click="search_click"></i>
        <div class="keyword_container">
          <div class="keyword" @click="keyword_click">
            <i class="far fa-hand-point-right"></i>
            {{search_keyword[0]}}
          </div>
          <div class="keyword" @click="keyword_click">
            <i class="far fa-hand-point-right"></i>
            {{search_keyword[1]}}
          </div>
          <div class="keyword" @click="keyword_click">
            <i class="far fa-hand-point-right"></i>
            {{search_keyword[2]}}
          </div>
          <div class="keyword" @click="keyword_click">
            <i class="far fa-hand-point-right"></i>
            {{search_keyword[3]}}
          </div>
          <div class="keyword" @click="keyword_click">
            <i class="far fa-hand-point-right"></i>
            {{search_keyword[4]}}
          </div>
          <div class="keyword" @click="keyword_click">
            <i class="far fa-hand-point-right"></i>
            {{search_keyword[5]}}
          </div>
        </div>
      </div>

      <div class="mem_bt" @click="mem_bt_click" v-if="mem_login == true">
        <a href="#"></a>
      </div>
      <div class="login_bt" v-if="mem_login == false">
        <a href="./login.html"></a>
      </div>
      <div class="mem_list" @click="stopPropagation">
        <div class="paint_border"></div>
        <ul>
          <li>
            <a href="./profile.html">
              <h4>Profile</h4>
            </a>
          </li>
          <li>
            <a href="./songsadded.html">
              <h4>
                Song Upload
                <br />&amp; Remove
              </h4>
            </a>
          </li>
          <li>
            <a href="./store.html">
              <h4>
                Store Value
                <br />&amp;Store Record
              </h4>
            </a>
          </li>
          <li>
            <a href="./donate.html">
              <h4>Donate Record</h4>
            </a>
          </li>
          <li @click="logout">
            <a href="#">
              <h4>Log Out</h4>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <!-- nav_bar end -->
  </div>
  <script src="./js/nav_bar.js"></script>
  <div id="player">
    <audio src="" id="audioPlayer"></audio>
    <div class="player_s">
      <div class="info">
        <div class="cover"><img src="./img/collection/album1.jpg"></div>
        <div class="songInfo">
          <span class="name">Lucid Dreamer</span>
          <span class="creator">Spazz Cardigan</span>
        </div>
        <div class="heart"><img src="./img/collection/grayheart.png" alt=""></div>
        <div class="clearfix"></div>
      </div>

      <div class="controlPanel">
        <div class="progressbar">
          <div class="progress"></div>
        </div>
        <div class="time">
          <span class="start">00:00</span>
          <span class="end">04:30</span>
          <div class="clearfix"></div>
        </div>
        <div class="btns">
          <div class="controls">
            <button class="prev"><i class="fas fa-step-backward"></i></button>
            <button class="play"><i class="fas fa-play"></i></button>
            <button class="next"><i class="fas fa-step-forward"></i></button>
            <button class="stop"><i class="fas fa-stop"></i></button>
            <button class="rand"><i class="fas fa-random"></i></button>
            <button class="loop"><i class="fas fa-undo-alt"></i></button>
            <div class="clearfix"></div>
          </div>
          <div class="vol">
            <div class="volicon"><i class="fas fa-volume-down"></i></div>
            <div class="volLine">
              <div class="volControl"></div>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="clearfix"></div>
        </div>
      </div>

      <div class="expand" id="expand"><i class="fas fa-expand"></i></div>
      <div class="clearfix"></div>
    </div>

    <!-- 詳細版 -->
    <div class="player_b">
      <div class="left">
        <div class="info">
          <div class="songCover">
            <img src="./img/collection/album1.jpg">
            <div class="coverRec"><img src="./img/library/player_record.png" alt=""></div>
          </div>
        </div>
        <div class="songInfo">
          <div class="name">Lucid Dreamer</div>
          <div class="creator">Spazz Cardigan</div>
          <div class="heart"><img src="./img/collection/grayheart.png" alt=""></div>
          <div class="clearfix"></div>
        </div>
        <div class="controlPanel">
          <div class="progressbar">
            <div class="progress"></div>
          </div>
          <div class="time">
            <span class="start">00:00</span>
            <span class="end">00:00</span>
            <div class="clearfix"></div>
          </div>
          <div class="btns">
            <div class="controls">
              <button class="rand"><i class="fas fa-random"></i></button>
              <button class="prev"><i class="fas fa-step-backward"></i></button>
              <button class="play"><i class="fas fa-play"></i></button>
              <button class="next"><i class="fas fa-step-forward"></i></button>
              <button class="stop"><i class="fas fa-stop"></i></button>
              <button class="loop"><i class="fas fa-undo-alt"></i></button>
              <div class="clearfix"></div>
            </div>
            <div class="vol">
              <div class="volicon"><i class="fas fa-volume-down"></i></div>
              <div class="volLine">
                <div class="volControl"></div>
              </div>
              <div class="clearfix"></div>
            </div>
            <div class="clearfix"></div>
          </div>
        </div>
        <div class="pushBtn"></div>
      </div>

      <div class="right">
        <div class="pushBtn"></div>
        <div class="listTitle">
          <div class="listCover">
            <img src="./img/library/list_pic_no.jpg"></div>
          <div class="listName">
            <h2>Total songs</h2>
            <span>0 songs</span>
          </div>
          <button class="selectBtn" id="selectBtn">SELECT</button>
          <div class="clearfix"></div>
        </div>
        <div class="list">
          <ul class="chooseList">
            <!-- <li>
              <div class="songCover">
                <img src="./img/collection/album1.jpg" alt="">
                <div class="listPlay nowlistening"><img src="./img/library/coverPlay-s.png"></div>
              </div>
              <div class="listSongInfo">
                <div class="name">
                  <h4>Lucid Dreamer</h4>
                  <p> Spazz Cardigan</p>
                </div>
              </div>
              <div class="totalTime">3:11</div>
              <div class="heart becomeRed"><img src="./img/collection/redheart.png"></div>
              <div class="clearfix"></div>
            </li> -->
          </ul>
        </div>
        <input type="hidden" id="playerfavorStatus" name="favorStatus">
        <input type="hidden" id="playerFavorSong" name="favorSong">
      </div>
      <div class="close" id="closePlayer"><i class="fas fa-times"></i></div>
      <div class="clearfix"></div>

      <!-- 撥放器燈箱 -->
      <div class="lightCover">
        <div class="lightbox_s allmylist" id="myAllList">
          <div class="closeLight"><i class="fas fa-times"></i></div>
          <h4>My List</h4>
          <div class="lightSelectMenu">
            <ul>
              <!-- <li class="chooseList">Liked songs</li> -->
            </ul>
          </div>
          <input type="hidden" name="plistName" id="plistName">
          <button id="mylistOK">ok</button>
        </div>
        <div class="lightbox_s" id="playerAlert">
          <div class="closeLight"><i class="fas fa-times"></i></div>
          <h4></h4>
          <button>ok</button>
        </div>
      </div>
    </div>
  </div>
  <div id="profile_app">
    <header class="my_header">
      <img src="./img/member/title_profile.png" alt="">
    </header>
    <div class="profile_content">
      <div class="profile_container flexbox">
        <div class="profile_leftbox">
          <div class="profile_mem_img">
            <div class="edit" @click="photo_edit_click">Edit</div>
          </div>
        </div>
        <div class="profile_rightbox">
          <div class="edit_box">
            <div class="th" v-if="name_edit == true">New Name</div>
            <div class="td" v-if="name_edit == true">
              <input class="name" type="text" maxlength="8"><label><i class="far fa-check-circle"></i></label>
            </div>
            <div class="th" v-if="psw_edit == true">New Password</div>
            <div class="td" v-if="psw_edit == true">
              <input class="psw" type="text" maxlength="20" placeholder="Enter New Password"><label><i
                  class="far fa-check-circle"></i></label>
            </div>
            <div class="psw_th" v-if="psw_edit == true">confirm Password</div>
            <div class="td" v-if="psw_edit == true">
              <input class="confirm_psw" type="password" maxlength="20" placeholder="Enter Password Again"><label><i
                  class="far fa-check-circle"></i></label>
            </div>
            <div class="warn">{{warn}}</div>
            <input class="cancel" type="button" value="cancel" @click="cancel_click">
            <input class="confirm" type="button" value="confirm" @click="confirm_click">
          </div>
          <div class="row row1 flexbox" v-if="name_edit == false && psw_edit == false">
            <div class="th flexbox">Account</div>
            <div class="td">{{mem_info.mem_acct}}</div>
          </div>
          <div class="row row2 flexbox" v-if="name_edit == false && psw_edit == false">
            <div class="th flexbox">Name</div>
            <div class="td">{{mem_info.mem_name}}</div>
            <div class="td_i flexbox" @click="name_edit_click">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
          <div class="row row3 flexbox" v-if="name_edit == false && psw_edit == false">
            <div class="th flexbox">Password</div>
            <div class="td">{{mem_info.mem_psw}}</div>
            <div class="td_i flexbox" @click="psw_edit_click">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
          <div class="row row4 flexbox" v-if="name_edit == false && psw_edit == false">
            <div class="th flexbox">Point</div>
            <div class="td">{{mem_info.mem_point}}</div>
            <div class="td_i flexbox">
              <a href="./store.html">
                <i class="fas fa-chevron-right"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="profile_lightbox" v-if="photo_edit == true">
      <div class="photo_edit_box">
        <label class="photo_preview" for="upfile">
          <input id="upfile" type="file" name="upfile" accept="image/*" @change="photo_upfile">
          <span class="plus1"></span>
          <span class="plus2"></span>
        </label>
        <p>
          Recommended image size is 300px &times 300px.
        </p>
        <input class="cancel" type="button" value="cancel" @click="cancel_click">
        <input class="confirm" type="button" value="confirm" @click="upfile_confirm">
      </div>
    </div>
    <div class="box_cover" v-if="my_alert == true">
      <div class="remind_box">
        <p></p>
        <input class="OK" type="button" value="OK" @click="my_alert = false">
      </div>
    </div>
  </div>

  <script>
    let p_vm = new Vue({
      el: "#profile_app",
      data: {
        // profile
        photo_edit: false,
        name_edit: false,
        psw_edit: false,
        my_alert: false,
        warn: '',

        test: true,
        // 會員資料
        mem_info: {
          mem_no: '',
          mem_acct: '',
          mem_name: '',
          mem_psw: '',
          mem_point: '',
          mem_img: '',
        },
        img_url: '',

        // 上傳圖片
        file: 'error',
      },
      mounted() {
        this.get_mem_info();
      },
      methods: {
        // profile start
        // init start
        get_mem_info() {
          let xhr = new XMLHttpRequest();
          xhr.onload = () => {
            let member = JSON.parse(xhr.responseText);
            this.mem_info.mem_no = member.mem_no;
            this.mem_info.mem_acct = member.mem_acct;
            this.mem_info.mem_name = member.mem_name;
            this.mem_info.mem_psw = (() => {
              let str = '';
              for (let i = 0; i < member.mem_psw.length; i++) {
                str += '●';
              }
              return str;
            })();
            this.mem_info.mem_point = member.mem_point;
            this.mem_info.mem_img = member.mem_img == null ? './img/member/no_img.png' : `./memberRepository/photo/${member.mem_no}/${member.mem_img}`;
            document.querySelector('.profile_mem_img').style.background = `url(${this.mem_info.mem_img})center center no-repeat`;
            document.querySelector('.profile_mem_img').style.backgroundSize = 'cover';
          }
          xhr.open("get", "./phps/getMemInfo.php", true);
          xhr.send(null);
        },

        // init end

        name_edit_click() {
          let w = document.querySelector('.profile_rightbox').offsetWidth;
          let h = document.querySelector('.profile_rightbox').offsetHeight;
          document.querySelector('.row2').style.transform = `translateX(${w}px)`;
          setTimeout(() => {
            for (let i = 1; i <= 4; i++) {
              if (i != 2) {
                document.querySelector(`.row${i}`).style.transform = `translateX(${w}px)`;
              }
            }
          }, 300)
          setTimeout(() => {
            this.name_edit = true;
            document.querySelector(`.edit_box`).style.width = `${w}px`;
            this.$nextTick(() => {
            })
          }, 400)
        },

        psw_edit_click() {
          let w = document.querySelector('.profile_rightbox').offsetWidth;
          document.querySelector('.row3').style.transform = `translateX(${w}px)`;
          setTimeout(() => {
            for (let i = 1; i <= 4; i++) {
              if (i != 3) {
                document.querySelector(`.row${i}`).style.transform = `translateX(${w}px)`;
              }
            }
          }, 300)
          setTimeout(() => {
            this.psw_edit = true;
            document.querySelector(`.edit_box`).style.width = `${w}px`;
            this.$nextTick(() => {
              document.querySelector('input.psw').addEventListener('input', input_check);
              document.querySelector('input.confirm_psw').addEventListener('input', input_check);
            })

          }, 400)
        },

        photo_edit_click() {
          this.photo_edit = true;
        },

        photo_upfile(e) {
          this.file = e.target.files[0];
          let reader = new FileReader();
          reader.addEventListener('load', (e) => {
            if (this.file.type.indexOf('image') == -1) {
              this.file = 'error';
              document.querySelector('.photo_edit_box p').innerHTML = 'The file you uploaded is not an image. Please upload again.'
              document.querySelector('.photo_edit_box p').style.color = 'red';
            } else {
              document.querySelector('.photo_edit_box p').innerHTML = 'Recommended image size is 300px &times 300px.'
              document.querySelector('.photo_preview').style.background = `url(${reader.result})center center no-repeat`;
              document.querySelector('.photo_preview').style.backgroundSize = `cover`;
              document.querySelector('.plus1').style.display = 'none';
              document.querySelector('.plus2').style.display = 'none';
              this.img_url = reader.result;
            }
          })
          reader.readAsDataURL(this.file);
        },

        cancel_click() {
          document.querySelector(`.edit_box`).style.width = `0px`;
          setTimeout(() => {
            this.name_edit = false;
            this.psw_edit = false;
          }, 300)
          this.photo_edit = false;
        },

        upfile_confirm() {
          if (this.file == 'error') {
            this.my_alert = true;
            this.$nextTick(() => {
              document.querySelector('.remind_box p').innerHTML = 'The file you uploaded is not an image. Please upload again.';
              document.querySelector('.remind_box p').style.color = 'red';
            })
            return;
          }
          let form_data = new FormData();
          form_data.append('upfile', this.file)
          let xhr = new XMLHttpRequest();
          xhr.onload = () => {
            let upload_status = xhr.responseText;
            this.photo_edit = false;
            this.my_alert = true;
            document.querySelector('.profile_mem_img').style.background = `url(${this.img_url})center center no-repeat`;
            document.querySelector('.profile_mem_img').style.backgroundSize = 'cover';
            this.$nextTick(() => {
              document.querySelector('.remind_box p').innerHTML = upload_status;
            })
          }
          xhr.open("post", "./phps/memPhotoUpload.php", true);
          xhr.send(form_data);
        },

        confirm_click() {
          let mem_name, mem_psw, mem_data, file
          if (this.name_edit == true) {
            mem_name = document.querySelector('input.name').value;
          }
          if (this.psw_edit == true) {
            mem_psw = document.querySelector('input.psw').value;
          }
          if (this.photo_edit == true) {
            file = this.file;
          }
          let xhr = new XMLHttpRequest();
          xhr.onload = () => {
            if (xhr.readyState == 4) {
              if (xhr.status == 200) {
                this.get_mem_info();
                let result = xhr.responseText;
                document.querySelector(`.edit_box`).style.width = `0px`;
                setTimeout(() => {
                  for (let i = 1; i <= 4; i++) {
                    document.querySelector(`.row${i}`).style.transform = `translateX(0px)`;
                  }
                }, 300)
                setTimeout(() => {
                  this.name_edit = false;
                  this.psw_edit = false;
                }, 300)
                this.my_alert = true;
                this.$nextTick(() => {
                  document.querySelector('.remind_box p').innerHTML = 'Edit success';
                })
              } else {
                alert('Edit fail');
              }
            }
          }
          xhr.open("post", "./phps/memEdit.php", true);
          xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
          if (this.name_edit == true) {
            mem_data = `mem_name=${mem_name}&edit=name`
          }
          if (this.psw_edit == true) {
            mem_data = `mem_psw=${mem_psw}&edit=psw`
          }
          if (this.photo_edit == true) {
            mem_data = `mem_psw=${mem_psw}&edit=photo`
          }

          xhr.send(mem_data);
        },

      }
    });

    let input_check = (e) => {
      if (p_vm.name_edit == true) {
      } else if (p_vm.psw_edit == true) {
        if (e.target == document.querySelector('input.psw')) {
          if (!e.target.value.replace(/\　/g, "")) {
            document.querySelector('.warn').innerHTML = 'Password cannot be empty!'
          } else {
            if (!/^(?=.{6,})/.test(e.target.value)) {
              document.querySelector('.warn').innerHTML = 'Password must be at least 6 characters!'
            } else {
              if (!/^(?=.*[0-9])(?=.*[a-zA-Z])[A-Za-z0-9]+$/.test(e.target.value)) {
                document.querySelector('.warn').innerHTML = 'Password must be at least one number and one letter!'
              } else {
                document.querySelector('.warn').innerHTML = '';
              }
            }
          }
        } else {
          if (!e.target.value.replace(/\　/g, "")) {
            document.querySelector('.warn').innerHTML = 'Password cannot be empty!'
          } else {
            if (!/^(?=.{6,})/.test(e.target.value)) {
              document.querySelector('.warn').innerHTML = 'Password must be at least 6 characters!'
            } else {
              if (!/^(?=.*[0-9])(?=.*[a-zA-Z])[A-Za-z0-9]+$/.test(e.target.value)) {
                document.querySelector('.warn').innerHTML = 'Password must be at least one number and one letter!'
              } else {
                if (e.target.value != document.querySelector('input.psw').value) {
                  document.querySelector('.warn').innerHTML = 'Inconsistent passwords, Please reconfirm!';
                } else {
                  document.querySelector('.warn').innerHTML = '';
                }
              }
            }
          }
        }
      }
    }
  </script>
  <script src="./js/player.js"></script>
</body>

</html>